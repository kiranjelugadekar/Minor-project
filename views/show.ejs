<%- layout('boilerplate') %>
<%- include('./includes/navbar') %>

<script>
    // Pass server-side variables to client-side JS
    const auctionStatus = "<%= product.auctionStatus %>";
    const auctionEndTime = "<%= product.auctionEndTime ? product.auctionEndTime.toISOString ? product.auctionEndTime.toISOString() : product.auctionEndTime : '' %>";
</script>

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-10">
            <!-- Back Button -->
            <div class="mb-3">
                <a href="/listings" class="btn btn-primary" >
                    <i class="fas fa-arrow-left me-2"></i>Back to Products
                </a>
            </div>

            <div class="row g-4">
                <!-- Product Image and Basic Info -->
                <div class="col-12 col-lg-6">
                    <div class="card h-100 shadow-sm">
                        <div class="position-relative">
                            <img src="<%= product.imageUrl %>" 
                                 class="card-img-top" 
                                 alt="<%= product.name %>"
                                 style="height: 400px; object-fit: cover;">
                            <div class="position-absolute top-0 end-0 m-3">
                                <span class="badge fs-6 <%= product.auctionStatus === 'active' ? 'bg-success' : product.auctionStatus === 'pending' ? 'bg-warning' : 'bg-secondary' %>">
                                    <%= product.auctionStatus.toUpperCase() %>
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <h2 class="card-title mb-3" style="color: #21808d;"><%= product.name %></h2>
                            
                            <div class="row g-3">
                                <div class="col-6">
                                    <div class="info-item">
                                        <small class="text-muted">Owner</small>
                                        <p class="mb-0 fw-semibold">
                                            <% if (product.owner) { %>
                                                <%= product.owner.username || 'Unknown User' %>
                                            <% } else { %>
                                                Unknown Owner
                                            <% } %>
                                        </p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="info-item">
                                        <small class="text-muted">Category</small>
                                        <p class="mb-0 fw-semibold"><%= product.category %></p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="info-item">
                                        <small class="text-muted">Condition</small>
                                        <p class="mb-0 fw-semibold"><%= product.condition %></p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="info-item">
                                        <small class="text-muted">Quantity</small>
                                        <p class="mb-0 fw-semibold"><%= product.quantity %></p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <h6 class="text-muted">Description</h6>
                                <p class="text-justify"><%= product.description %></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Auction Info and Bidding -->
                <div class="col-12 col-lg-6">
                    <div class="row g-4">
                        <!-- Auction Status and Timer -->
                        <div class="col-12">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body">
                                    <% if (product.auctionStatus === 'pending') { %>
                                        <div class="auction-status text-center py-4">
                                            <div class="display-1 mb-3">‚è≥</div>
                                            <h4 class="text-warning">Waiting for First Bid</h4>
                                            <p class="text-muted">Auction will start when someone places the first bid</p>
                                        </div>
                                    <% } else if (product.auctionStatus === 'active') { %>
                                        <div class="auction-active text-center">
                                            <h4 class="text-success mb-3">üî• Auction Active</h4>
                                            <%if(product.auctionEndTime){ %> 
                                                <div class="countdown-timer" data-end-time="<%= product.auctionEndTime.toISOString() %>">
                                            <% }else{ %>
                                                <div class="countdown-timer" data-end-time="<%= product.auctionEndTime %>">
                                            <% } %>
                                                <h5 class="mb-3">Time Remaining:</h5>
                                                <div id="timer-display" class="d-flex justify-content-center gap-3">
                                                    <div class="time-part text-center">
                                                        <div class="time-value text-white rounded p-2">
                                                            <span id="hours" class="fs-4 fw-bold">00</span>
                                                        </div>
                                                        <small class="text-muted">Hours</small>
                                                    </div>
                                                    <div class="time-part text-center">
                                                        <div class="time-value text-white rounded p-2">
                                                            <span id="minutes" class="fs-4 fw-bold">00</span>
                                                        </div>
                                                        <small class="text-muted">Minutes</small>
                                                    </div>
                                                    <div class="time-part text-center">
                                                        <div class="time-value text-white rounded p-2">
                                                            <span id="seconds" class="fs-4 fw-bold">00</span>
                                                        </div>
                                                        <small class="text-muted">Seconds</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    <% } else { %>
                                        <div class="auction-ended text-center py-4">
                                            <div class="display-1 mb-3">üèÅ</div>
                                            <h4 class="text-danger">Auction Ended</h4>
                                            <% if (product.winner) { %>
                                                <div class="winner-info mt-3 p-3 bg-light rounded">
                                                    <h6 class="text-success">üéâ Winner: <%= product.winner.username %></h6>
                                                    <h5 class="text-primary">Winning Bid: ‚Çπ<%= product.winningBid %></h5>
                                                </div>
                                            <% } else { %>
                                                <p class="text-muted">No bids were placed</p>
                                            <% } %>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>

                        <!-- Bidding Information -->
                        <div class="col-12">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title mb-4">üí∞ Bidding Information</h5>
                                    
                                    <div class="row g-3 mb-4">
                                        <div class="col-6">
                                            <div class="bid-info-card bg-light p-3 rounded text-center">
                                                <small class="text-muted">Starting Bid</small>
                                                <h4 class="text-primary mb-0">‚Çπ<%= product.startingBid %></h4>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="bid-info-card bg-success p-3 rounded text-center text-white">
                                                <small class="text-light">Current Bid</small>
                                                <h4 class="mb-0">‚Çπ<%= product.currentBid %></h4>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Bidding Section -->
                                    <div class="bid-section">
                                        <% if (product.auctionStatus !== 'ended') { %>
                                            <% if (currUser && !currUser._id.equals(product.owner._id) && currUser.userType !== 'admin') { %>
                                                <form action="/products/<%= product._id %>/bid" method="POST" class="bid-form">
                                                    <div class="form-group mb-3">
                                                        <label class="form-label fw-semibold">
                                                            <% if (product.auctionStatus === 'pending') { %>
                                                                üöÄ Your Bid Amount (‚Çπ) - Start the Auction!
                                                            <% } else { %>
                                                                üìà Your Bid Amount (‚Çπ)
                                                            <% } %>
                                                        </label>
                                                        <div class="input-group">
                                                            <span class="input-group-text">‚Çπ</span>
                                                            <input type="number" 
                                                                   name="amount" 
                                                                   class="form-control form-control-lg" 
                                                                   min="<%= (product.currentBid || product.startingBid) + 50 %>"
                                                                   placeholder="<%= (product.currentBid || product.startingBid) + 50 %>"
                                                                   required>
                                                        </div>
                                                        <small class="form-text text-muted">
                                                            Minimum bid: ‚Çπ<%= (product.currentBid || product.startingBid) + 50 %>
                                                        </small>
                                                    </div>
                                                    <% if (product.auctionStatus === 'pending') { %>
                                                        <button type="submit" class="btn btn-success btn-lg w-100">
                                                            üéØ Place First Bid & Start Auction!
                                                        </button>
                                                    <% } else { %>
                                                        <button type="submit" class="btn btn-primary btn-lg w-100">
                                                            üí™ Place Bid
                                                        </button>
                                                    <% } %>
                                                </form>
                                            <% } else if ((currUser && currUser._id.equals(product.owner._id)) || currUser.userType === 'admin') { %>
                                                <div class="admin-actions d-grid gap-2">
                                                    <a href="/listings/edit/<%= product._id %>" class="btn btn-warning btn-lg">
                                                        ‚úèÔ∏è Edit Product
                                                    </a>
                                                    <form action="/listings/delete/<%= product._id %>?_method=DELETE" method="post">
                                                        <button class="btn btn-danger btn-lg w-100" onclick="return confirm('Are you sure you want to delete this product?')">
                                                            üóëÔ∏è Delete Product
                                                        </button>
                                                    </form>
                                                </div>
                                            <% } else { %>
                                                <div class="alert alert-warning text-center">
                                                    <h6>üîí Please log in to place a bid</h6>
                                                    <a href="/signup" class="btn btn-primary">Login / Sign Up</a>
                                                </div>
                                            <% } %>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bid History -->
            <div class="row mt-5">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header text-white" style="background-color: #21808d;">
                            <h5 class="mb-0">üìã Bid History</h5>
                        </div>
                        <div class="card-body">
                            <% if (bids && bids.length > 0) { %>
                                <div class="bid-history-list">
                                    <% bids.forEach((bid, index) => { %>
                                        <div class="bid-item d-flex justify-content-between align-items-center py-3 <%= index === 0 ? 'border-bottom border-2 border-success' : 'border-bottom' %>">
                                            <div class="bid-info">
                                                <% if (index === 0) { %>
                                                    <span class="badge bg-success me-2">Highest</span>
                                                <% } %>
                                                <span class="bid-amount fs-5 fw-bold text-success">‚Çπ<%= bid.amount %></span>
                                                <span class="bidder-name ms-2">
                                                    by <strong><%= bid.bidder ? bid.bidder.username : 'Unknown User' %></strong>
                                                </span>
                                            </div>
                                            <small class="text-muted">
                                                <%= bid.timestamp.toLocaleString() %>
                                            </small>
                                        </div>
                                    <% }) %>
                                </div>
                            <% } else { %>
                                <div class="text-center py-5">
                                    <div class="display-1 text-muted">üìù</div>
                                    <h5 class="text-muted">No bids yet</h5>
                                    <p class="text-muted">Be the first to bid on this product!</p>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.time-value {
    min-width: 60px;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.time-part.urgent .time-value {
    color: #dc3545 !important;
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.info-item {
    padding: 0.5rem 0;
}

.bid-info-card {
    transition: all 0.3s ease;
}

.bid-info-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.bid-form .form-control:focus {
    border-color: #21808d;
    box-shadow: 0 0 0 0.2rem rgba(33, 128, 141, 0.25);
}

.btn-primary {
    background-color: #21808d;
    border-color: #21808d;
}

.btn-primary:hover {
    background-color: #1a6672;
    border-color: #1a6672;
}

.card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.card:hover {
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    transition: all 0.3s ease;
}

@media (max-width: 768px) {
    .time-value {
        min-width: 50px;
        min-height: 50px;
    }
    
    .time-value span {
        font-size: 1.2rem !important;
    }
    
    .container-fluid {
        padding: 1rem;
    }
}
</style>

<script>
// Timer functionality for active auctions
if (auctionStatus === 'active' && auctionEndTime) { 
    document.addEventListener('DOMContentLoaded', function() {
        const endTime = new Date(auctionEndTime).getTime();
        
        function updateTimer() {
            const now = new Date().getTime();
            const timeLeft = endTime - now;
            
            if (timeLeft <= 0) {
                document.getElementById('timer-display').innerHTML = '<div class="alert alert-danger"><h4>Auction Ended!</h4></div>';
                setTimeout(() => location.reload(), 2000);
                return;
            }
            
            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            // Update individual elements
            document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
            document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
            document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
            
            // Add urgent styling when less than 1 minute left
            if (timeLeft < 60000) {
                document.querySelectorAll('.time-part').forEach(part => part.classList.add('urgent'));
            }
        }

        updateTimer();
        const interval = setInterval(updateTimer, 1000);
    });
}
</script>